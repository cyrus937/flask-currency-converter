<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - Currency Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        .login-card {
            max-width: 400px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .alert-danger {
            border-radius: 10px;
            border: none;
            background-color: #ffe6e6;
            color: #d63384;
        }
        .loading {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="login-card p-4">
                    <div class="text-center mb-4">
                        <i class="fas fa-exchange-alt fa-3x text-primary mb-3"></i>
                        <h2 class="fw-bold">Currency Converter</h2>
                        <p class="text-muted">Connectez-vous à votre compte</p>
                    </div>

                    <!-- Alert pour les erreurs -->
                    <div id="error-alert" class="alert alert-danger d-none" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="error-message"></span>
                    </div>

                    <!-- Formulaire de connexion -->
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="email" class="form-label">
                                <i class="fas fa-envelope me-2"></i>Email
                            </label>
                            <input type="email" class="form-control" id="email" required 
                                   placeholder="votre@email.com">
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock me-2"></i>Mot de passe
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" required 
                                       placeholder="••••••••">
                                <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="remember-me">
                            <label class="form-check-label" for="remember-me">
                                Se souvenir de moi
                            </label>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-3">
                            <span class="normal-text">
                                <i class="fas fa-sign-in-alt me-2"></i>Se connecter
                            </span>
                            <span class="loading">
                                <i class="fas fa-spinner fa-spin me-2"></i>Connexion...
                            </span>
                        </button>
                    </form>

                    <div class="text-center">
                        <p class="mb-2">
                            <a href="#" class="text-decoration-none">Mot de passe oublié ?</a>
                        </p>
                        <p class="text-muted">
                            Pas encore de compte ? 
                            <a href="/register" class="text-decoration-none fw-bold">S'inscrire</a>
                        </p>
                    </div>

                    <!-- Démonstration -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <small class="text-muted d-block mb-2">
                            <i class="fas fa-info-circle me-1"></i>Compte de démonstration:
                        </small>
                        <div class="row">
                            <div class="col-6">
                                <small><strong>Email:</strong><br>demo@example.com</small>
                            </div>
                            <div class="col-6">
                                <small><strong>Mot de passe:</strong><br>demo123456</small>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100 mt-2" 
                                onclick="fillDemoCredentials()">
                            <i class="fas fa-magic me-1"></i>Utiliser le compte démo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // Vérifier si déjà connecté
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('access_token');
            if (token) {
                // Vérifier la validité du token
                axios.get('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).then(response => {
                    // Token valide, rediriger vers le dashboard
                    window.location.href = '/dashboard/';
                }).catch(error => {
                    // Token invalide, le supprimer
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                });
            }
        });

        // Toggle password visibility
        document.getElementById('toggle-password').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        // Remplir les identifiants de démonstration
        function fillDemoCredentials() {
            document.getElementById('email').value = 'demo@example.com';
            document.getElementById('password').value = 'demo123456';
        }

        // Fonction pour afficher les erreurs
        function showError(message) {
            const errorAlert = document.getElementById('error-alert');
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.textContent = message;
            errorAlert.classList.remove('d-none');
            
            // Auto-hide après 5 secondes
            setTimeout(() => {
                errorAlert.classList.add('d-none');
            }, 5000);
        }

        // Fonction pour masquer les erreurs
        function hideError() {
            document.getElementById('error-alert').classList.add('d-none');
        }

        // Fonction pour afficher/masquer le loading
        function toggleLoading(show) {
            const normalText = document.querySelector('.normal-text');
            const loadingText = document.querySelector('.loading');
            const submitBtn = document.querySelector('button[type="submit"]');
            
            if (show) {
                normalText.style.display = 'none';
                loadingText.style.display = 'inline';
                submitBtn.disabled = true;
            } else {
                normalText.style.display = 'inline';
                loadingText.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        // Gestion du formulaire de connexion
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            hideError();
            toggleLoading(true);
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            try {
                const response = await axios.post('/api/auth/login', {
                    email: email,
                    password: password
                });
                
                const data = response.data;

                console.log('Connexion réussie:', data);
                
                // Stocker les tokens
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);
                localStorage.setItem('user_id', data.user.id);
                
                if (rememberMe) {
                    localStorage.setItem('user_email', email);
                }
                
                // Rediriger vers le dashboard
                window.location.href = '/dashboard/';

                // goToDashboard();
                
            } catch (error) {
                let errorMessage = 'Erreur lors de la connexion';
                
                if (error.response && error.response.data && error.response.data.error) {
                    errorMessage = error.response.data.error;
                } else if (error.response) {
                    switch (error.response.status) {
                        case 401:
                            errorMessage = 'Email ou mot de passe incorrect';
                            break;
                        case 500:
                            errorMessage = 'Erreur serveur. Veuillez réessayer plus tard.';
                            break;
                        default:
                            errorMessage = 'Une erreur inattendue s\'est produite';
                    }
                }
                
                showError(errorMessage);
                toggleLoading(false);
            }
        });

        // Auto-remplir l'email si sauvegardé
        document.addEventListener('DOMContentLoaded', function() {
            const savedEmail = localStorage.getItem('user_email');
            if (savedEmail) {
                document.getElementById('email').value = savedEmail;
                document.getElementById('remember-me').checked = true;
            }
        });

        // Permettre la soumission avec Enter
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') {
                document.getElementById('login-form').dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>